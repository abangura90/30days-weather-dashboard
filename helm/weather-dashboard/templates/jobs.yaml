apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "weather-dashboard.fullname" . }}-initial
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "weather-dashboard.labels" . | nindent 4 }}
    job-type: initial-run
spec:
  backoffLimit: 1
  template:
    spec:
      serviceAccountName: {{ include "weather-dashboard.serviceAccountName" . }}
      containers:
      - name: {{ .Chart.Name }}-initial
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy }}
        env:
        {{- range $key, $value := .Values.env }}
        - name: {{ $key }}
          {{- if $value.valueFrom }}
          valueFrom:
            {{- toYaml $value.valueFrom | nindent 12 }}
          {{- else }}
          value: {{ $value.value | quote }}
          {{- end }}
        {{- end }}
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
      restartPolicy: Never
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "weather-dashboard.fullname" . }}
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "weather-dashboard.labels" . | nindent 4 }}
    job-type: recurring
spec:
  schedule: "*/5 * * * *"  # Every 5 minutes
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: {{ include "weather-dashboard.serviceAccountName" . }}
          containers:
          - name: {{ .Chart.Name }}
            image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
            imagePullPolicy: {{ .Values.image.pullPolicy }}
            env:
            {{- range $key, $value := .Values.env }}
            - name: {{ $key }}
              {{- if $value.valueFrom }}
              valueFrom:
                {{- toYaml $value.valueFrom | nindent 16 }}
              {{- else }}
              value: {{ $value.value | quote }}
              {{- end }}
            {{- end }}
            resources:
              {{- toYaml .Values.resources | nindent 14 }}
          restartPolicy: OnFailure